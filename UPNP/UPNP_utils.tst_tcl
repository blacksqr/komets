package require udp
package require http

#___________________________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________________________
method UPNP_server constructor {} {
 set this(multi_cast_ip)  239.255.255.250
 set this(multicast_port) 1900
 
 set this(tcp_server_socket) [socket -server "$objName New_message_from_TCP_5000" 5000]
 
 set this(L_devices)      [list]
 
 set this(socket_server_udp_multicast) [udp_open] 
 puts "udp socket : $this(socket_server_udp_multicast)"
 fconfigure $this(socket_server_udp_multicast) -blocking 0 -broadcast 1\
											   -remote [list $this(multi_cast_ip) $this(multicast_port)] \
											   -mcastadd $this(multi_cast_ip)
											   
 fileevent $this(socket_server_udp_multicast) readable [list $objName New_message_from_multicast $this(socket_server_udp_multicast)]
}

#___________________________________________________________________________________________________________________________________________
method UPNP_server dispose {} {
 fconfigure $this(socket_server_udp_multicast) -mcastdrop $this(multi_cast_ip)
 close $this(socket_server_udp_multicast)
 close $this(tcp_server_socket)
 this inherited
}

#___________________________________________________________________________________________________________________________________________
method UPNP_server get_infos {} {
 puts [list multi_cast_ip $this(multi_cast_ip) multicast_port $this(multicast_port) port [fconfigure $this(socket_server_udp_multicast) -myport]]
 puts "UDP socket :"
 puts [fconfigure $this(socket_server_udp_multicast)]
}

#___________________________________________________________________________________________________________________________________________
method UPNP_server New_message_from_TCP_5000 {sock addr port} {
 fconfigure $sock -blocking 0
 fileevent  $sock readable [list $objName getting_TCP_msg_on $sock]
}

#___________________________________________________________________________________________________________________________________________
method UPNP_server getting_TCP_msg_on {chan} {
 set msg [read $chan]
 puts "$objName receiving from TCP-5000 :\n$msg"
 if {[eof $chan]} {close $chan}
}

#___________________________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________________________
method UPNP_server New_message_from_multicast {chan} {
 set data [read $chan]
 puts "$objName received from multicast UDP :\n$data"
}

#___________________________________________________________________________________________________________________________________________
method UPNP_server Send_msg_discovery {} {
 set msg {M-SEARCH * HTTP/1.1
HOST: 239.255.255.250:1900
MAN: ssdp:discover
MX: 10
ST: ssdp:all
}

 set msg {M-SEARCH * HTTP/1.1
HOST: 239.255.255.250:1900
MAN: ssdp:discover
MX: 10
ST: upnp:rootdevice
}

 puts $msg
 puts $this(socket_server_udp_multicast) $msg
 flush $this(socket_server_udp_multicast)
}
